<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Charity Events</title>
<style>
  body { font-family: 'Arial', sans-serif; margin:0; padding:0; background:#f5f5f5; color:#333; }
  a { text-decoration:none; color:inherit; }
  button { cursor:pointer; }

  header { background:#2c3e50; color:#fff; padding:15px 30px; display:flex; justify-content:space-between; align-items:center; }
  header h1 { margin:0; font-size:24px; }
  header button { background:#e74c3c; border:none; padding:8px 12px; color:#fff; border-radius:5px; }

  footer { background:#2c3e50; color:#fff; text-align:center; padding:15px; margin-top:20px; }

  #loginPage { display:flex; justify-content:center; align-items:center; height:100vh; background:#34495e; }
  #loginBox { background:#fff; padding:40px; border-radius:10px; width:320px; box-shadow:0 0 20px rgba(0,0,0,0.3); }
  #loginBox h2 { text-align:center; margin-bottom:20px; color:#2c3e50; }
  #loginBox input { width:100%; padding:10px; margin-bottom:15px; border-radius:5px; border:1px solid #ccc; }
  #loginBox button { width:100%; padding:10px; background:#2c3e50; color:#fff; border:none; border-radius:5px; font-size:16px; }
  #loginError { color:red; text-align:center; margin-bottom:10px; }

  #dashboard { display:none; padding:20px 30px; }
  .overview { display:flex; gap:20px; margin-bottom:20px; }
  .overview div { background:#fff; flex:1; padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); text-align:center; }
  .overview div h3 { margin:0; font-size:16px; color:#555; }
  .overview div p { font-size:22px; margin:8px 0 0; color:#2c3e50; }

  table { width:100%; border-collapse:collapse; background:#fff; border-radius:10px; overflow:hidden; box-shadow:0 0 10px rgba(0,0,0,0.1); margin-bottom:20px; }
  table th, table td { padding:10px; text-align:left; border-bottom:1px solid #eee; }
  table th { background:#2c3e50; color:#fff; }
  table tr:hover { background:#f1f1f1; }
  .action-btn { padding:5px 10px; border:none; border-radius:5px; margin-right:5px; color:#fff; font-size:14px; }
  .edit-btn { background:#f39c12; }
  .delete-btn { background:#e74c3c; }
  .add-btn { background:#27ae60; margin-bottom:10px; font-size:14px; padding:5px 10px; }

  .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
  .modal-content { background:#fff; padding:20px; border-radius:10px; width:400px; max-height:90vh; overflow-y:auto; position:relative; }
  .modal-content h3 { margin-top:0; text-align:center; color:#2c3e50; }
  .modal-content input, .modal-content textarea, .modal-content select { width:100%; padding:8px; margin-bottom:10px; border:1px solid #ccc; border-radius:5px; }
  .modal-content button { padding:10px 15px; border:none; border-radius:5px; margin-right:5px; background:#2c3e50; color:#fff; }
  .close-btn { position:absolute; top:10px; right:15px; background:red; color:#fff; font-weight:bold; border:none; border-radius:5px; padding:5px 10px; cursor:pointer; }
</style>
</head>
<body>

<header>
  <h1>Port Moresby Charity Events - Admin</h1>
  <button id="logoutBtn" style="display:none;">Logout</button>
</header>

<div id="loginPage">
  <div id="loginBox">
    <h2>Admin Login</h2>
    <div id="loginError"></div>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
  </div>
</div>

<div id="dashboard">
  <div class="overview">
    <div><h3>Total Events</h3><p id="totalEvents">0</p></div>
    <div><h3>Past Events</h3><p id="pastEvents">0</p></div>
    <div><h3>Today's Events</h3><p id="todayEvents">0</p></div>
  </div>

  <h2>Events <button class="add-btn" onclick="openEventModal()">Add Event</button></h2>
  <table id="eventsTable">
    <thead>
      <tr><th>ID</th><th>Title</th><th>Date</th><th>Time</th><th>Location</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Registrations <button class="add-btn" onclick="openRegModal()">Add Registration</button></h2>
  <table id="regsTable">
    <thead>
      <tr><th>ID</th><th>First Name</th><th>Last Name</th><th>Event</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="modal" id="eventModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeEventModal()">X</button>
    <h3 id="eventModalTitle">Add Event</h3>
    <input type="hidden" id="eventId">
    <input type="text" id="eventTitle" placeholder="Title">
    <input type="date" id="eventDate">
    <input type="time" id="eventTime">
    <input type="text" id="eventLocation" placeholder="Location">
    <textarea id="eventDesc" placeholder="Description"></textarea>
    <textarea id="eventDetails" placeholder="Details"></textarea>
    <input type="number" id="eventMax" placeholder="Max Attendees">
    <button onclick="saveEvent()">Save</button>
  </div>
</div>

<div class="modal" id="regModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeRegModal()">X</button>
    <h3 id="regModalTitle">Add Registration</h3>
    <input type="hidden" id="regId">
    <input type="text" id="firstName" placeholder="First Name">
    <input type="text" id="lastName" placeholder="Last Name">
    <select id="regEvent"></select>
    <button onclick="saveReg()">Save</button>
  </div>
</div>

<footer>Port Moresby Charity Events &copy; 2025</footer>

<script>
const API_URL = 'http://localhost:3060/api';
let events = [];
let registrations = [];

// Login
document.getElementById('loginBtn').addEventListener('click', async () => {
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  if(username==='admin' && password==='admin123'){
    document.getElementById('loginPage').style.display='none';
    document.getElementById('dashboard').style.display='block';
    document.getElementById('logoutBtn').style.display='block';
    loadDashboard();
  }else{
    document.getElementById('loginError').innerText='Invalid credentials';
  }
});

// Logout
document.getElementById('logoutBtn').addEventListener('click', ()=>{
  if(confirm('Are you sure you want to logout?')) location.reload();
});

async function loadDashboard(){
  try{
    const eventsRes = await fetch(API_URL+'/events');
    events = await eventsRes.json();
    const regsRes = await fetch(API_URL+'/registrations');
    registrations = await regsRes.json();
  }catch(e){
    console.error('Fetch failed, using localStorage fallback');
    events = JSON.parse(localStorage.getItem('events')||'[]');
    registrations = JSON.parse(localStorage.getItem('registrations')||'[]');
  }
  populateEvents();
  populateRegs();
  updateOverview();
  populateEventSelect();
}

function updateOverview(){
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('totalEvents').innerText = events.length;
  document.getElementById('pastEvents').innerText = events.filter(e=>e.date<today).length;
  document.getElementById('todayEvents').innerText = events.filter(e=>e.date===today).length;
}

function populateEvents(){
  const tbody = document.querySelector('#eventsTable tbody'); tbody.innerHTML='';
  events.forEach(e=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${e.id}</td><td>${e.title}</td><td>${e.date}</td><td>${e.time}</td><td>${e.location}</td>
      <td><button class="action-btn edit-btn" onclick="editEvent(${e.id})">Edit</button>
      <button class="action-btn delete-btn" onclick="deleteEvent(${e.id})">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

function populateRegs(){
  const tbody=document.querySelector('#regsTable tbody'); tbody.innerHTML='';
  registrations.forEach(r=>{
    const eventName=events.find(e=>e.id===r.eventId)?.title||'';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.id}</td><td>${r.firstName}</td><td>${r.lastName}</td><td>${eventName}</td>
      <td><button class="action-btn edit-btn" onclick="editReg(${r.id})">Edit</button>
      <button class="action-btn delete-btn" onclick="deleteReg(${r.id})">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

function openEventModal(){
  document.getElementById('eventModal').style.display='flex';
  document.getElementById('eventModalTitle').innerText='Add Event';
  ['eventId','eventTitle','eventDate','eventTime','eventLocation','eventDesc','eventDetails','eventMax'].forEach(id=>document.getElementById(id).value='');
}
function closeEventModal(){ document.getElementById('eventModal').style.display='none'; }
async function saveEvent(){
  const id=document.getElementById('eventId').value;
  const payload={
    title:document.getElementById('eventTitle').value,
    date:document.getElementById('eventDate').value,
    time:document.getElementById('eventTime').value,
    location:document.getElementById('eventLocation').value,
    description:document.getElementById('eventDesc').value,
    details:document.getElementById('eventDetails').value,
    maxAttendees:parseInt(document.getElementById('eventMax').value)
  };
  if(id){
    await fetch(`${API_URL}/events/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).catch(()=>{});
  }else{
    await fetch(`${API_URL}/events`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).catch(()=>{});
  }
  loadDashboard(); closeEventModal();
}
function editEvent(id){
  const e=events.find(ev=>ev.id===id);
  document.getElementById('eventModal').style.display='flex';
  document.getElementById('eventModalTitle').innerText='Edit Event';
  document.getElementById('eventId').value=e.id;
  document.getElementById('eventTitle').value=e.title;
  document.getElementById('eventDate').value=e.date;
  document.getElementById('eventTime').value=e.time;
  document.getElementById('eventLocation').value=e.location;
  document.getElementById('eventDesc').value=e.description;
  document.getElementById('eventDetails').value=e.details;
  document.getElementById('eventMax').value=e.maxAttendees;
}
async function deleteEvent(id){
  if(confirm('Delete this event?')){
    await fetch(`${API_URL}/events/${id}`,{method:'DELETE'}).catch(()=>{});
    loadDashboard();
  }
}

function openRegModal(){
  document.getElementById('regModal').style.display='flex';
  document.getElementById('regModalTitle').innerText='Add Registration';
  ['regId','firstName','lastName'].forEach(id=>document.getElementById(id).value='');
}
function closeRegModal(){ document.getElementById('regModal').style.display='none'; }
async function saveReg(){
  const id=document.getElementById('regId').value;
  const payload={
    firstName:document.getElementById('firstName').value,
    lastName:document.getElementById('lastName').value,
    eventId:parseInt(document.getElementById('regEvent').value)
  };
  if(id){
    await fetch(`${API_URL}/registrations/${id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).catch(()=>{});
  }else{
    await fetch(`${API_URL}/registrations`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}).catch(()=>{});
  }
  loadDashboard(); closeRegModal();
}
function editReg(id){
  const r=registrations.find(rg=>rg.id===id);
  document.getElementById('regModal').style.display='flex';
  document.getElementById('regModalTitle').innerText='Edit Registration';
  document.getElementById('regId').value=r.id;
  document.getElementById('firstName').value=r.firstName;
  document.getElementById('lastName').value=r.lastName;
  document.getElementById('regEvent').value=r.eventId;
}
async function deleteReg(id){
  if(confirm('Delete this registration?')){
    await fetch(`${API_URL}/registrations/${id}`,{method:'DELETE'}).catch(()=>{});
    loadDashboard();
  }
}

function populateEventSelect(){
  const select=document.getElementById('regEvent'); select.innerHTML='';
  events.forEach(e=>{ select.innerHTML+=`<option value="${e.id}">${e.title}</option>`; });
}
</script>
</body>
</html>
